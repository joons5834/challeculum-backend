<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="companion.challeculum.domains.userground.UserGroundDao">
    <!--Jonghyun-->
    <sql id="select_userground_joined">

        select ug.id, ug.user_id, ground_id, is_attending, is_success, rating, comment,
               oauth_id, username, password, nickname, phone, point, mission_score, role,
               lecture_id, title, information, level, min_capacity, max_capacity, deposit, is_validated, is_premium, created_at, start_at, end_at, validated_at, status, mission_fail_limit
        from user_ground ug join user u on u.id = ug.user_id join ground g on g.id = ug.ground_id
    </sql>
    <select id="getUserGround" resultType="userGround">
        select * from user_ground where user_id = #{userId} and ground_id=#{ground_id};
    </select>
    <select id="getUserGroundJoined" resultType="userGroundJoined">
        <include refid="select_userground_joined"/> where ug.user_id = #{userId} and ug.ground_id=#{groundId};
    </select>
    <select id="getUserGroundJoinedListByGroundId" resultType="userGroundJoined">
        <include refid="select_userground_joined"/> where ug.ground_id = #{groundId}
    </select>

    <select id="getUserGroundListByGroundId" resultType="userGround">
        select * from user_ground where ground_id = #{groundId}
    </select>
    <!--End of Jonghyun-->

    <!--Kiyoung-->
    <!--End of Kiyoung-->

    <!--Sojeong-->
    <!--End of Sojeong-->

    <!--Hwajun-->
    <!--End of Hwajun-->

    <!--HyunJoon-->
    <insert id="participateGround">
        INSERT INTO user_ground (user_id, ground_id)
        VALUES (#{userId}, #{groundId})
    </insert>

    <update id="participateGroundUpdate">
        UPDATE user_ground
        SET is_attending = 1
        WHERE user_id = #{userId}
          AND ground_id = #{groundId}
    </update>

    <update id="deductDeposit">
        UPDATE user
        SET point = (select point FROM user WHERE id = #{userId}) - (select deposit FROM ground WHERE id = #{groundId})
        WHERE id = #{userId}
    </update>

    <select id="getMaxCapacity" resultType="int">
        SELECT max_capacity
        FROM ground
        WHERE id = #{groundId}
    </select>

    <select id="countParticipant" resultType="int">
        SELECT count(*)
        FROM user_ground
        WHERE ground_id = #{groundId}
          AND is_attending = 1
    </select>

    <select id="getDeposit" resultType="int">
        SELECT deposit
        FROM ground
        WHERE id = #{groundId}
    </select>

    <select id="getPoint" resultType="int">
        SELECT point
        FROM user
        WHERE id = #{userId}
    </select>

    <select id="getOnDoingLecture" resultType="int">
        SELECT is_completed
        FROM user_lecture
        WHERE user_id = #{userId}
          AND lecture_id = (SELECT lecture_id FROM ground WHERE id = #{groundId})
    </select>

    <select id="checkFirstParticipant" resultType="int">
        SELECT count(*)
        FROM user_ground
        WHERE user_id = #{userId}
          AND ground_id = #{groundId}
          AND is_attending = 0
    </select>

    <update id="cancelParticipateGround">
        UPDATE user_ground
        SET is_attending = 0
        WHERE user_id = #{userId}
          AND ground_id = #{groundId}
    </update>

    <update id="receiveDeposit">
        UPDATE user
        SET point = (select point FROM user WHERE id = #{userId}) + (select deposit FROM ground WHERE id = #{groundId})
        WHERE id = #{userId}
    </update>
    <!--End Of HyunJoon-->


</mapper>
